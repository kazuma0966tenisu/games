<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tank Game - Final Fix</title>
    <style>
        * { box-sizing: border-box; }
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            height: 100dvh; /* ÊúÄÊñ∞„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅßÈ´ò„Åï„ÇíÊ≠£Á¢∫„Å´ÂèñÂæó */
            background-color: #e0e0e0;
            overflow: hidden;
            touch-action: none;
            position: fixed; /* „Çπ„ÇØ„É≠„Éº„É´„ÇíÂÆåÂÖ®„Å´Èò≤Ê≠¢ */
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        #portrait-warning {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #333;
            color: white;
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: sans-serif;
            text-align: center;
        }
        @media screen and (orientation: portrait) {
            #portrait-warning { display: flex; }
        }
    </style>
</head>
<body>

<div id="portrait-warning">
    <h2>„Çπ„Éû„Éõ„ÇíÊ®™Âêë„Åç„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
    <p>Please rotate your device to landscape mode.</p>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // „Ç≥„É≥„Éà„É≠„Éº„É´UI
    const controls = {
        move: { x: 100, y: 0, r: 50, color: 'rgba(0, 116, 217, 0.5)', activeId: null, vecX: 0, vecY: 0 },
        aim:  { x: 0, y: 0, r: 50, color: 'rgba(255, 65, 54, 0.5)', activeId: null, vecX: 0, vecY: 0 },
        fire: { x: 0, y: 0, r: 40, color: 'rgba(255, 220, 0, 0.5)', activeId: null }
    };

    function applyResize() {
        // „Éñ„É©„Ç¶„Ç∂„ÅÆÂÆüÈöõ„ÅÆË°®Á§∫„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
        const w = window.innerWidth;
        const h = window.innerHeight;
        
        canvas.width = w;
        canvas.height = h;

        // „Éú„Çø„É≥„ÅåÁîªÈù¢Â§ñ„Å™„Çâ‰∏≠Â§Æ‰ªòËøë„Å´Êàª„Åô
        const margin = 50;
        if (controls.move.x < margin || controls.move.x > w - margin) controls.move.x = 100;
        if (controls.move.y < margin || controls.move.y > h - margin) controls.move.y = h - 100;

        if (controls.aim.x < margin || controls.aim.x > w - margin) controls.aim.x = w - 100;
        if (controls.aim.y < margin || controls.aim.y > h - margin) controls.aim.y = h - 100;

        if (controls.fire.x < margin || controls.fire.x > w - margin) controls.fire.x = w - 220;
        if (controls.fire.y < margin || controls.fire.y > h - margin) controls.fire.y = h - 100;
        
        // ÂÜçÊèèÁîª„Çí‰øÉ„Åô
        if(gameState === 'SETUP') drawSetup();
    }

    // ÂõûËª¢„Éª„É™„Çµ„Ç§„Ç∫ÊôÇ„Å´Ë§áÊï∞ÂõûÂÆüË°å„Åó„Å¶Áúü„Å£ÁôΩ„ÇíÈò≤„Åê
    window.addEventListener('resize', () => {
        applyResize();
        setTimeout(applyResize, 100);
        setTimeout(applyResize, 500);
    });
    window.addEventListener('orientationchange', () => {
        setTimeout(applyResize, 200);
    });

    // ÂàùÊúüÂåñ
    let gameState = 'SETUP';
    let level = 1;
    let lives = 3;
    let score = 0;
    let draggingControl = null;
    let particles = [];
    let player, enemies = [], bullets = [], blocks = [];

    // --- „Çø„ÉÉ„ÉÅÂá¶ÁêÜ ---
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const pos = { x: touch.clientX, y: touch.clientY };

        if (gameState === 'SETUP') {
            if (pos.x > canvas.width/2 - 75 && pos.x < canvas.width/2 + 75 && pos.y > 20 && pos.y < 70) {
                initLevel(level);
                gameState = 'PLAYING';
                return;
            }
            if (Math.hypot(pos.x - controls.move.x, pos.y - controls.move.y) < controls.move.r) draggingControl = controls.move;
            else if (Math.hypot(pos.x - controls.aim.x, pos.y - controls.aim.y) < controls.aim.r) draggingControl = controls.aim;
            else if (Math.hypot(pos.x - controls.fire.x, pos.y - controls.fire.y) < controls.fire.r) draggingControl = controls.fire;
        } 
        else if (gameState === 'PLAYING') {
            for (let t of e.changedTouches) {
                if (Math.hypot(t.clientX - controls.fire.x, t.clientY - controls.fire.y) < controls.fire.r) {
                    fireBullet();
                } else if (Math.hypot(t.clientX - controls.move.x, t.clientY - controls.move.y) < controls.move.r) {
                    controls.move.activeId = t.identifier;
                } else if (Math.hypot(t.clientX - controls.aim.x, t.clientY - controls.aim.y) < controls.aim.r) {
                    controls.aim.activeId = t.identifier;
                }
            }
        }
    }, {passive: false});

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (gameState === 'SETUP' && draggingControl) {
            draggingControl.x = e.touches[0].clientX;
            draggingControl.y = e.touches[0].clientY;
        } else if (gameState === 'PLAYING') {
            for (let t of e.touches) {
                if (t.identifier === controls.move.activeId) {
                    let dx = t.clientX - controls.move.x, dy = t.clientY - controls.move.y;
                    let d = Math.hypot(dx, dy) || 1;
                    controls.move.vecX = dx/d; controls.move.vecY = dy/d;
                }
                if (t.identifier === controls.aim.activeId) {
                    let dx = t.clientX - controls.aim.x, dy = t.clientY - controls.aim.y;
                    let d = Math.hypot(dx, dy) || 1;
                    controls.aim.vecX = dx/d; controls.aim.vecY = dy/d;
                }
            }
        }
    }, {passive: false});

    canvas.addEventListener('touchend', (e) => {
        draggingControl = null;
        for (let t of e.changedTouches) {
            if (t.identifier === controls.move.activeId) { controls.move.activeId = null; controls.move.vecX = 0; controls.move.vecY = 0; }
            if (t.identifier === controls.aim.activeId) { controls.aim.activeId = null; controls.aim.vecX = 0; controls.aim.vecY = 0; }
        }
    });

    // --- „Ç≤„Éº„É†„Ç®„É≥„Ç∏„É≥ ---
    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            let a = Math.random() * 6.28, s = Math.random() * 4 + 1;
            this.vx = Math.cos(a) * s; this.vy = Math.sin(a) * s;
            this.life = 1.0;
        }
        update() { this.x += this.vx; this.y += this.vy; this.life -= 0.03; }
        draw() {
            ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
            ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, 6.28); ctx.fill(); ctx.globalAlpha = 1;
        }
    }

    class Tank {
        constructor(x, y, color, type) {
            this.x = x; this.y = y; this.color = color; this.type = type;
            this.angle = 0; this.cooldown = 0; this.dead = false; this.fireTimer = 100;
        }
        draw() {
            if (this.dead) return;
            ctx.save(); ctx.translate(this.x, this.y);
            ctx.fillStyle = this.color; ctx.fillRect(-12, -12, 24, 24);
            ctx.rotate(this.angle); ctx.fillStyle = '#333'; ctx.fillRect(0, -4, 20, 8);
            ctx.restore();
        }
    }

    class Bullet {
        constructor(x, y, vx, vy, isP) {
            this.x = x; this.y = y; this.vx = vx; this.vy = vy; this.isP = isP; this.b = 0; this.dead = false;
        }
        update() {
            this.x += this.vx;
            if (this.x < 4 || this.x > canvas.width-4 || isHitWall(this.x, this.y)) { this.vx *= -1; this.x += this.vx; this.b++; }
            this.y += this.vy;
            if (this.y < 4 || this.y > canvas.height-4 || isHitWall(this.x, this.y)) { this.vy *= -1; this.y += this.vy; this.b++; }
            if (this.b > 1) this.dead = true;
        }
        draw() { ctx.fillStyle = this.isP ? '#333' : '#a00'; ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, 6.28); ctx.fill(); }
    }

    function isHitWall(x, y) {
        return blocks.some(b => x > b.x && x < b.x+b.w && y > b.y && y < b.y+b.h);
    }

    function fireBullet() {
        if (!player || player.dead || player.cooldown > 0) return;
        let vx = Math.cos(player.angle)*6, vy = Math.sin(player.angle)*6;
        bullets.push(new Bullet(player.x + Math.cos(player.angle)*20, player.y + Math.sin(player.angle)*20, vx, vy, true));
        player.cooldown = 30;
    }

    function initLevel(lvl) {
        player = new Tank(100, canvas.height/2, '#0074D9', 'player');
        enemies = [new Tank(canvas.width-150, canvas.height/2, '#85144b', 'stationary')];
        if(lvl > 1) enemies.push(new Tank(canvas.width-150, 100, '#FF4136', 'moving'));
        bullets = []; blocks = [{x: canvas.width/2-20, y: canvas.height/4, w: 40, h: canvas.height/2}];
        particles = [];
    }

    function drawSetup() {
        ctx.fillStyle = '#333'; ctx.font = '18px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText('„Éú„Çø„É≥„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÈÖçÁΩÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', canvas.width/2, canvas.height/2);
        ctx.fillStyle = '#2ECC40'; ctx.fillRect(canvas.width/2-75, 20, 150, 40);
        ctx.fillStyle = 'white'; ctx.fillText('GAME START', canvas.width/2, 47);
        drawUI();
    }

    function drawUI() {
        [controls.move, controls.aim, controls.fire].forEach((c, i) => {
            ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, 6.28);
            ctx.fillStyle = c.color; ctx.fill(); ctx.strokeStyle = 'white'; ctx.stroke();
            ctx.fillStyle = 'white'; ctx.fillText(['ÁßªÂãï','Á†≤Âè∞','üí£'][i], c.x, c.y+5);
        });
    }

    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (gameState === 'SETUP') {
            drawSetup();
        } else if (gameState === 'PLAYING') {
            // ÁßªÂãï
            if(controls.move.vecX) {
                let nx = player.x + controls.move.vecX*2.5, ny = player.y + controls.move.vecY*2.5;
                if(!isHitWall(nx, ny) && nx > 15 && nx < canvas.width-15) player.x = nx;
                if(!isHitWall(player.x, ny) && ny > 15 && ny < canvas.height-15) player.y = ny;
            }
            if(controls.aim.vecX) player.angle = Math.atan2(controls.aim.vecY, controls.aim.vecX);
            if(player.cooldown > 0) player.cooldown--;

            // ÊïµAI
            enemies.forEach(e => {
                e.angle = Math.atan2(player.y - e.y, player.x - e.x);
                e.fireTimer--;
                if(e.fireTimer <= 0) {
                    bullets.push(new Bullet(e.x+Math.cos(e.angle)*20, e.y+Math.sin(e.angle)*20, Math.cos(e.angle)*4, Math.sin(e.angle)*4, false));
                    e.fireTimer = Math.max(40, 150 - level*20);
                }
                e.draw();
            });

            bullets.forEach((b, i) => {
                b.update(); b.draw();
                // „Éó„É¨„Ç§„É§„ÉºÂΩì„Åü„ÇäÂà§ÂÆö
                if((!b.isP || b.b > 0) && Math.hypot(b.x-player.x, b.y-player.y) < 16) {
                    lives--; b.dead = true; 
                    for(let k=0; k<20; k++) particles.push(new Particle(player.x, player.y, player.color));
                    if(lives <= 0) gameState = 'GAME_OVER';
                }
                // ÊïµÂΩì„Åü„ÇäÂà§ÂÆö
                if(b.isP || b.b > 0) {
                    enemies.forEach(e => {
                        if(Math.hypot(b.x-e.x, b.y-e.y) < 16) {
                            e.dead = true; b.dead = true; score += 100;
                            for(let k=0; k<20; k++) particles.push(new Particle(e.x, e.y, e.color));
                        }
                    });
                }
            });
            
            bullets = bullets.filter(b => !b.dead);
            enemies = enemies.filter(e => !e.dead);
            if(enemies.length === 0) { level++; initLevel(level); }

            blocks.forEach(b => { ctx.fillStyle = '#8B4513'; ctx.fillRect(b.x, b.y, b.w, b.h); });
            particles.forEach(p => { p.update(); p.draw(); });
            particles = particles.filter(p => p.life > 0);
            player.draw();
            drawUI();
            ctx.fillStyle = '#333'; ctx.textAlign = 'left'; ctx.fillText(`Lv: ${level} Score: ${score} ÂëΩ: ${lives}`, 10, 25);
        } else if (gameState === 'GAME_OVER') {
            ctx.fillStyle = 'black'; ctx.font = '30px sans-serif'; ctx.textAlign = 'center';
            ctx.fillText('GAME OVER', canvas.width/2, canvas.height/2);
            ctx.font = '15px sans-serif'; ctx.fillText('„Çø„ÉÉ„Éó„Åß„É™„Éà„É©„Ç§', canvas.width/2, canvas.height/2 + 40);
            canvas.onclick = () => { location.reload(); };
        }
        
        requestAnimationFrame(gameLoop);
    }

    applyResize();
    gameLoop();
</script>
</body>
</html>
